---
name: Testing Requirements
description: Automated testing rules for components
---

# Testing Requirements

## Every Component Needs 3 Files

When creating a component, generate:
1. `ComponentName.tsx` - Implementation
2. `ComponentName.test.tsx` - Unit & integration tests
3. `ComponentName.stories.tsx` - Visual documentation

## 1. Unit Tests (React Native Testing Library)

### Snapshot Test (visual regression)
```tsx
import { render } from '@testing-library/react-native';
import { Button } from '../button';

describe('Button', () => {
  it('matches snapshot', () => {
    const tree = render(<Button onPress={() => {}}>Click</Button>).toJSON();
    expect(tree).toMatchSnapshot();
  });
});
```

### Interaction Test (behavior)
```tsx
import { fireEvent } from '@testing-library/react-native';

it('calls onPress when tapped', () => {
  const onPress = jest.fn();
  const { getByRole } = render(<Button onPress={onPress}>Click</Button>);
  fireEvent.press(getByRole('button'));
  expect(onPress).toHaveBeenCalled();
});
```

### Accessibility Test
```tsx
it('has minimum touch target size', () => {
  const { getByRole } = render(<Button onPress={() => {}}>Click</Button>);
  const button = getByRole('button');
  // Touch target should be at least 44x44 on mobile
  expect(button.props.style).toMatchObject({
    minHeight: 44,
    minWidth: 44,
  });
});
```

## 2. Storybook Stories (Visual Testing)

**Required**: Every component needs a `.stories.tsx` file

```tsx
// button.stories.tsx
import { View } from 'react-native';
import { Button } from './button';

export default {
  title: 'Components/Button',
  component: Button,
};

export const Primary = () => (
  <View style={{ padding: 20, backgroundColor: '#EEEDED' }}>
    <Button variant="primary" onPress={() => console.log('Pressed')}>
      Primary Button
    </Button>
  </View>
);

export const Secondary = () => (
  <View style={{ padding: 20, backgroundColor: '#EEEDED' }}>
    <Button variant="secondary" onPress={() => console.log('Pressed')}>
      Secondary Button
    </Button>
  </View>
);

export const Disabled = () => (
  <View style={{ padding: 20, backgroundColor: '#EEEDED' }}>
    <Button disabled onPress={() => {}}>
      Disabled Button
    </Button>
  </View>
);
```

**Why**: Visual documentation + manual testing of all variants

## 3. Visual Regression (Chromatic - Free Tier Strategy)

**Goal**: Stay within free tier, maximize value

### What to Snapshot (Priority Order):

1. **Custom Components** (Always test)
   - FAB, SquircleView, custom wrappers
   - YOUR code, YOUR responsibility

2. **Streaming States** (High value - unique to your apps)
   - Empty, partial, complete states
   - Progressive rendering
   - This catches bugs other apps don't have

3. **Critical Layouts** (Selected testing)
   - ControlCenter (mobile & web variants)
   - Modal/Sheet layouts
   - Main screens

### What to SKIP:

- ❌ Vanilla Reusables components (trust upstream)
- ❌ Third-party UI (Lucide icons, etc.)
- ❌ Simple text/layout-only stories

### Snapshot Budget Management

Chromatic free tier: ~5000 snapshots/month

**Estimated usage**:
- 10 custom components × 3 variants = 30 snapshots
- 5 streaming components × 5 states = 25 snapshots  
- 3 layouts × 2 breakpoints = 6 snapshots
- **Total: ~60 snapshots/build**
- **Monthly**: ~1800 snapshots (well within limit!)

### Setup

```bash
# Install
bun add -D chromatic

# Run visual regression
npx chromatic --project-token=<token>
```

### In CI (GitHub Actions)
```yaml
- name: Visual Regression
  run: npx chromatic --exit-zero-on-changes
  env:
    CHROMATIC_PROJECT_TOKEN: ${{ secrets.CHROMATIC_TOKEN }}
```

## 4. E2E Testing (For Critical Flows)

**Tool**: Maestro (simple) or Detox (comprehensive)

```yaml
# flows/button-interaction.yaml (Maestro)
appId: com.darkresearch.minimalapp
---
- tapOn: "Primary Button"
- assertVisible: "Success"
```

**When to use**: Critical user flows (login, checkout, etc.)

## Testing Checklist (Before Completing)

### Required (Every component):
- ✅ `bun test` - All unit tests pass
- ✅ `bun run lint` - No lint errors  
- ✅ `bun run storybook` - Visual check all variants
- ✅ Component has .test.tsx + .stories.tsx files

### Performance (During development):
- ✅ Check console for re-render warnings
- ✅ Use whyDidYouRender if debugging performance
- ✅ Run performance budget test (1000 renders <100ms)

### Visual Regression (Custom components only):
- ✅ Story created for each variant
- ✅ Snapshots focused on custom/streaming states
- ✅ Skip vanilla Reusables (stay in free tier)

### Accessibility:
- ✅ Touch targets ≥44px on mobile
- ✅ accessibilityLabel on interactive elements
- ✅ accessibilityRole defined
- ✅ Test with VoiceOver/TalkBack if critical
