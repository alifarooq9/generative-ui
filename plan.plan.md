# Expo SDK 54 Upgrade and Monorepo Restructure

## Current State
- Expo SDK 51 → Target: SDK 54
- React 18.2.0 → Target: React 19.1.0
- React Native 0.74.5 → Target: React Native 0.81.0
- Structure: `dev/` at root, `examples/minimal-app/` → Target: `apps/*` structure

## Phase 1: Preserve Dev App Content

### 1.1 Create Archive Documentation
- Create `dev/ARCHIVE.md` documenting all features/components to preserve:
  - Components: `ContentArea`, `ControlCenter` (web/mobile variants), `Header`, `TestComponents`
  - Hooks: `useStreaming`, `useFonts`, `useKeyboardNavigation`
  - Contexts: `DebugContext` with debug state management
  - Constants: `presets.ts`, `colors.ts`, `paperTheme.ts` (note: paperTheme uses react-native-paper, should be rebuilt with Reusables)
  - Features: Streaming simulation, preset system, theme toggle, debug panel, component registry
  - **Note**: Current implementation uses `react-native-paper` - when rebuilding, replace with React Native Reusables components

### 1.2 Archive Dev App
- Move `dev/` → `dev-archive/` (or comment out in workspaces temporarily)
- This preserves all code for future reference when rebuilding on minimal-app boilerplate

## Phase 2: Restructure Monorepo

### 2.1 Create Apps Directory
- Create `apps/` directory at root
- Move `examples/minimal-app/` → `apps/minimal-app/`
- Update root `package.json` workspaces:
  ```json
  "workspaces": [
    "apps/*",
    "packages/*"
  ]
  ```

### 2.2 Update Path References
- Update `apps/minimal-app/metro.config.js` to use new paths (remove manual monorepo config for SDK 52+)
- Update any import paths in packages that reference `examples/`
- Update documentation (README.md) to reflect new structure

## Phase 3: Upgrade Dependencies

### 3.1 Root Package.json
- Update `expo` to `~54.0.0` (if needed at root)
- Update `react` resolution/override to `^19.1.0`
- Update `@types/react` resolution/override to `~19.0.0` (was `^18.0.0`)
- Review and remove any unnecessary resolutions/overrides (SDK 54 may have fixed issues)
- Keep `nativewind`, `tailwindcss`, `typescript` at compatible versions

### 3.2 Apps (minimal-app)
- Update `expo` to `~54.0.0`
- Update `react` to `19.1.0`
- Update `react-dom` to `19.1.0`
- Update `react-native` to `0.81.0`
- **Remove `react-native-paper`** from dependencies (not used, replaced by Reusables)
- Run `npx expo install --fix` to update all Expo packages to SDK 54 compatible versions
- Update `@types/react` to `~19.0.0`
- Update `react-native-web` to compatible version
- Update all `expo-*` packages via `expo install --fix`
- **Update `apps/minimal-app/app.json`**: Add experimental autolinking resolution:
  ```json
  {
    "expo": {
      "experiments": {
        "autolinkingModuleResolution": true
      }
    }
  }
  ```
  This prevents mismatches between native and JavaScript modules (SDK 54 feature)

### 3.3 Packages
- **design-system**: Update peer dependencies to `react: "*"`, `react-native: "*"` (already flexible)
- **streamdown-rn**: Update peer dependencies to support React 19 and RN 0.81
- **galerie-rn**: Update peer dependencies and dev dependencies

### 3.4 Third-Party Dependencies
- Check compatibility of:
  - `react-native-markdown-display`
  - `react-native-svg`
  - `react-native-webview`
  - `@hugeicons/react-native`
  - `nativewind` (verify v4 compatibility with RN 0.81)
  - All other React Native packages

## Phase 4: Update Metro Configuration

### 4.1 Remove Manual Monorepo Config (SDK 52+)
- Update `apps/minimal-app/metro.config.js`:
  - Remove `watchFolders` (auto-detected in SDK 52+)
  - Remove `resolver.nodeModulesPaths` (auto-detected in SDK 52+)
  - Remove `resolver.extraNodeModules` if present (auto-detected)
  - Remove `resolver.disableHierarchicalLookup` if present (no longer needed)
  - Keep NativeWind wrapper: `withNativeWind(config, { input: '../../global.css' })`
  - Use `getDefaultConfig(__dirname)` from `expo/metro-config` (auto-configures monorepo)
  - Final config should be minimal: just getDefaultConfig + NativeWind wrapper

### 4.2 Verify Metro Config
- Ensure using `getDefaultConfig` from `expo/metro-config`
- Test that workspace packages resolve correctly
- Run `npx expo start --clear` to clear Metro cache after config changes

## Phase 5: Update Native Projects

### 5.1 Regenerate Native Projects
- Delete `apps/minimal-app/ios/` and `apps/minimal-app/android/` if they exist
- Run `npx expo prebuild` to regenerate with SDK 54
- Verify native builds work

### 5.2 Update Native Dependencies
- Ensure CocoaPods/Podfile is updated (auto-generated by prebuild)
- **Check Podfile.properties.json**: Verify `ios.useFrameworks` is not set to `true` unless absolutely necessary
  - `use_frameworks!` disables precompiled iOS frameworks (10x slower builds)
  - Only enable if required by a specific dependency
- Run `pod install` in iOS directory after prebuild
- Verify Podfile uses dynamic paths (already correct: uses `node --print "require.resolve(...)"`)

## Phase 6: TypeScript and Type Updates

### 6.1 Update Type Definitions
- Update `@types/react` to `~19.0.0` across all packages
- Update `@types/react-native` to match RN 0.81
- Fix any TypeScript errors from React 19 changes (e.g., children prop changes)

### 6.2 Update tsconfig.json
- Verify `skipLibCheck` is enabled if needed
- Ensure module resolution works with new structure

## Phase 7: Testing and Validation

### 7.1 Verify Builds
- Run `bun install` from root
- Run `bun run build` to build all packages
- **Run `npx expo-doctor@latest`** to check for configuration issues and incompatible dependencies
- Test `apps/minimal-app` starts: `cd apps/minimal-app && npx expo start --clear`

### 7.2 Check for Breaking Changes
- Review Expo SDK 54 changelog for breaking changes
- Review React 19 migration guide
- Review React Native 0.81 release notes
- Fix any compatibility issues
- **Note**: React Compiler is enabled by default in SDK 54 templates - may reduce need for manual `useMemo`/`useCallback` optimizations

## Phase 8: Documentation Updates

### 8.1 Update README
- Update structure diagram to show `apps/*` instead of `examples/*`
- Update quick start instructions
- Remove references to `dev/` app (or note it's archived)

### 8.2 Update Package Docs
- Update any package READMEs that reference old structure
- Update workspace dependency examples

## Key Files to Modify

1. **Root `package.json`**: Workspaces, resolutions (update to React 19), dependencies
2. **`apps/minimal-app/package.json`**: All dependency versions, remove react-native-paper
3. **`apps/minimal-app/app.json`**: Add `experiments.autolinkingModuleResolution: true`
4. **`apps/minimal-app/metro.config.js`**: Remove all manual monorepo config (watchFolders, nodeModulesPaths, etc.)
5. **`packages/*/package.json`**: Peer dependencies
6. **Root `README.md`**: Structure documentation
7. **TypeScript configs**: Type definitions
8. **`apps/minimal-app/ios/Podfile.properties.json`**: Verify `ios.useFrameworks` is not enabled (for precompiled frameworks)

## Notes

- Expo SDK 54 uses React Native 0.81 (not 0.82) - this is the latest supported
- SDK 52+ auto-configures Metro for monorepos - manual config can be removed
- React 19 has some breaking changes (children prop, types) - may need code updates
- Native projects should be regenerated with `expo prebuild` after upgrade
- Dev app archived in `dev-archive/` for reference when rebuilding
- **react-native-paper removed** - replaced by React Native Reusables in design-system
- **SDK 54 Best Practices**:
  - Precompiled iOS frameworks enabled by default (10x faster builds) - avoid `use_frameworks!` unless necessary
  - `autolinkingModuleResolution` prevents native/JS module mismatches
  - React Compiler enabled by default - reduces need for manual optimizations
  - Run `expo-doctor` after upgrade to catch configuration issues
  - Metro config should be minimal - SDK auto-detects monorepo structure

